name: Kernel Build (Motorola Parrot Only)
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential python3 gcc-aarch64-linux-gnu \
          libelf-dev bison flex libssl-dev qtbase5-dev wget pahole curl unzip

      - name: Fetch Toolchain
        run: |
          mkdir -p clang
          curl -L "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android14-release/clang-r487747c.tar.gz" -o clang.tar.gz
          tar -xzf clang.tar.gz -C clang

      - name: Sewing Phase
        run: |
          # 1. Motorola Base (The Skeleton)
          curl -L "https://github.com/MotorolaMobilityLLC/kernel-msm/archive/refs/heads/android-14-release-u2ubs34.44-86-7.zip" -o base.zip
          unzip -q base.zip && cp -rf kernel-msm-android-14-release-u2ubs34.44-86-7/* ./
          
          # 2. Motorola Blobs (Stock Binaries)
          curl -L "https://github.com/MotorolaMobilityLLC/motorola-kernel-modules/archive/refs/heads/android-14-release-u2ub34.44-30-6r1.zip" -o blobs.zip
          unzip -q blobs.zip && cp -rf motorola-kernel-modules-android-14-release-u2ub34.44-30-6r1/* ./

          # 3. Download SusFS
          curl -L "https://gitlab.com/khanning/susfs4kg/-/raw/main/kernel_patches/5.10/susfs.patch" -o susfs.patch

          rm -rf *.zip kernel-msm-* motorola-kernel-modules-*

      - name: Build Kernel
        run: |
          export PATH=$(pwd)/clang/bin:$PATH
          export ARCH=arm64
          export SUBARCH=arm64
          export KBUILD_BUILD_USER=Nick
          export KBUILD_BUILD_HOST=KernelOS
          
          # Apply SusFS
          if [ -f "susfs.patch" ]; then
            patch -p1 < susfs.patch || echo "Patch applied with offsets"
          fi

          # Using the Parrot config found in your logs
          make O=out CC=clang ARCH=arm64 vendor/parrot_GKI.config vendor/ext_config/moto-parrot.config
          
          make -j$(nproc --all) O=out \
            CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-gnu- \
            LD=ld.lld AR=llvm-ar NM=llvm-nm \
            OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: KernelOS-Parrot-Image
          path: out/arch/arm64/boot/Image*
