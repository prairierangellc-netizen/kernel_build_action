name: Build Parrot Kernel + SusFS
on:
  push:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev clang lld llvm
          
      - name: Clone Source and Tools
        run: |
          git clone https://github.com/MotorolaMobilityLLC/kernel-msm --depth 1 source
          git clone https://gitlab.com/vyt74c/susfs4ksu --depth 1 susfs
          # Using a faster, pre-built GKI toolchain
          mkdir clang && curl -L https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r450784e.tar.gz | tar -xzC clang

      - name: Patch SusFS
        run: |
          cp susfs/kernel_patches/5.15/set_susfs.sh source/
          cp susfs/kernel_patches/fs/susfs.c source/fs/
          cp susfs/kernel_patches/include/linux/susfs.h source/include/linux/
          cd source
          patch -p1 < ../susfs/kernel_patches/5.15/0001-susfs-v1.5.5-to-kernel-5.15.patch || true

      - name: Build Kernel
        run: |
          cd source
          export PATH=$(pwd)/../clang/bin:$PATH
          make O=out ARCH=arm64 gki_defconfig
          scripts/kconfig/merge_config.sh -O out arch/arm64/configs/gki_defconfig arch/arm64/configs/vendor/parrot_GKI.config
          make -j$(nproc) O=out ARCH=arm64 CC=clang CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-android-

      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: Parrot-Kernel-SusFS
          path: source/out/arch/arm64/boot/Image
