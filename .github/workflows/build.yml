name: Kernel Build (Brain & Nerves Priority)
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential python3 gcc-aarch64-linux-gnu \
          libelf-dev bison flex libssl-dev qtbase5-dev wget pahole curl unzip

      - name: Fetch Toolchain
        run: |
          mkdir -p clang
          curl -L "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android14-release/clang-r487747c.tar.gz" -o clang.tar.gz
          tar -xzf clang.tar.gz -C clang

      - name: Sewing Phase
        run: |
          # Kill the ghost submodule error
          git rm --cached prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 || true
          
          # 1. Base Skeleton
          curl -L "https://github.com/MotorolaMobilityLLC/kernel-msm/archive/refs/heads/android-14-release-u2ubs34.44-86-7.zip" -o base.zip
          unzip -q base.zip && cp -rf kernel-msm-android-14-release-u2ubs34.44-86-7/* ./
          
          # 2. Blobs (Stock Binaries)
          curl -L "https://github.com/MotorolaMobilityLLC/motorola-kernel-modules/archive/refs/heads/android-14-release-u2ub34.44-30-6r1.zip" -o blobs.zip
          unzip -q blobs.zip && cp -rf motorola-kernel-modules-android-14-release-u2ub34.44-30-6r1/* ./

          # 3. Nerves (Custom Stylus Drivers) - Using direct main branch zip
          curl -L "https://github.com/devicespooflabs/android_vendor_stylus_nerves/archive/refs/heads/main.zip" -o nerves.zip
          unzip -q nerves.zip && cp -rf android_vendor_stylus_nerves-main/* ./ || echo "Warning: Nerves unzip failed"

          # 4. Brain (Custom Logic/Hooks)
          curl -L "https://github.com/devicespooflabs/android_vendor_stylus_brain/archive/refs/heads/main.zip" -o brain.zip
          unzip -q brain.zip && cp -rf android_vendor_stylus_brain-main/* ./ || echo "Warning: Brain unzip failed"

          # 5. Apply susfs
          curl -L "https://gitlab.com/khanning/susfs4kg/-/raw/main/kernel_patches/5.10/susfs.patch" -o susfs.patch
          # We check if the file is valid before patching
          if [ -f "susfs.patch" ]; then
            patch -p1 < susfs.patch || echo "susfs patch skipped"
          fi

          rm -rf *.zip kernel-msm-* motorola-kernel-modules-* android_vendor_stylus_* susfs.patch

      - name: Verify Config Presence
        run: |
          if [ ! -f "arch/arm64/configs/vendor/wayne_defconfig" ]; then
            echo "ERROR: wayne_defconfig not found in arch/arm64/configs/vendor/"
            ls -R arch/arm64/configs/vendor/ || true
            exit 1
          fi

      - name: Build Kernel
        run: |
          export PATH=$(pwd)/clang/bin:$PATH
          export ARCH=arm64
          export SUBARCH=arm64
          export KBUILD_BUILD_USER=Nick
          export KBUILD_BUILD_HOST=KernelOS
          
          make O=out CC=clang ARCH=arm64 vendor/wayne_defconfig
          
          make -j$(nproc --all) O=out \
            CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-gnu- \
            LD=ld.lld AR=llvm-ar NM=llvm-nm \
            OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: KernelOS-Final-Build
          path: out/arch/arm64/boot/Image.gz-dtb
